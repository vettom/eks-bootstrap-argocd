apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cert-manager
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: cert-manager
    server: https://kubernetes.default.svc
  project: core
  syncPolicy:
    automated: {}
    syncOptions:
      - CreateNamespace=true
  source:
    repoURL: https://charts.jetstack.io
    chart: cert-manager
    targetRevision: {{ .Values.certmanager.version }}
    helm:
      valuesObject:
        installCRDs: true
        namespace: "cert-manager"
        replicaCount: {{ .Values.certmanager.replicaCount }}
        config:
          apiVersion: controller.config.cert-manager.io/v1alpha1
          kind: ControllerConfiguration
          enableGatewayAPI: true
        securityContext:
          fsGroup: 1001
        serviceAccount:
          create: true
          name: "cert-manager-{{ .Values.cluster_name }}"
          annotations:
            eks.amazonaws.com/role-arn: arn:aws:iam::{{ .Values.aws_account_id }}:role/cert-manager-{{ .Values.cluster_name }}
        podDisruptionBudget:
          enabled: true
          maxUnavailable: 1
        enableCertificateOwnerRef: true
        dns01RecursiveNameservers: "8.8.8.8:53,8.8.4.4:53"
        resources:
          limits:
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 64Mi
        prometheus:
          servicemonitor:
            enabled: true
            labels:
              release: kube-prometheus-stack
        cainjector:
          enabled: true
          replicaCount: 1
          resources:
            limits:
              memory: 128Mi
            requests:
              cpu: 10m
              memory: 32Mi
        global:
          leaderElection:
            namespace: "cert-manager"